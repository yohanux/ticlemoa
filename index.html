<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body { font-family: sans-serif; margin: 0; padding: 0; }
      .navbar {
        background: #222; color: #fff; padding: 16px 24px; font-size: 1.3em;
        font-weight: bold; letter-spacing: 1px;
      }
      .rss-buttons {
        display: flex; gap: 12px; padding: 16px 24px; background: #f5f5f5;
        border-bottom: 1px solid #eee;
      }
      .rss-buttons button {
        padding: 8px 18px; border: none; border-radius: 6px; background: #eee;
        cursor: pointer; font-size: 1em; transition: background 0.2s;
      }
      .rss-buttons button.active {
        background: #0070f3; color: #fff;
      }
      #rss { padding: 24px; }
    </style>
  </head>
  <body>
    <div class="navbar">아티커 - 아티클 모아보기</div>
    <div class="rss-buttons" id="rss-buttons"></div>
    <div id="rss"></div>
    <script>
      // 여러 RSS 피드 URL을 배열로 관리
      const feeds = [
        {
          name: '토스테크',
          url: 'https://api.rss2json.com/v1/api.json?rss_url=https://toss.tech/rss.xml',
          icon: 'resources/tosstech.png'
        },
        {
          name: '우아한테크블로그',
          url: 'https://api.rss2json.com/v1/api.json?rss_url=https://techblog.woowahan.com/feed/',
          icon: 'resources/woowahan.ico'
        }
      ];

      // 버튼 생성
      const btnContainer = document.getElementById('rss-buttons');
      // 전체 버튼 추가
      const allBtn = document.createElement('button');
      allBtn.textContent = '전체';
      allBtn.onclick = () => selectFeed('all');
      allBtn.classList.add('active');
      btnContainer.appendChild(allBtn);
      feeds.forEach((feed, idx) => {
        const btn = document.createElement('button');
        btn.textContent = feed.name;
        btn.onclick = () => selectFeed(idx);
        btnContainer.appendChild(btn);
      });

      // 피드 선택 및 표시
      function selectFeed(idx) {
        // 버튼 active 처리
        Array.from(btnContainer.children).forEach((btn, i) => {
          if(idx === 'all') {
            btn.classList.toggle('active', i === 0);
          } else {
            btn.classList.toggle('active', i === idx + 1);
          }
        });
        document.getElementById('rss').innerText = '불러오는 중...';
        if(idx === 'all') {
          // 모든 피드 fetch
          Promise.all(feeds.map(feed =>
            fetch(feed.url)
              .then(response => response.json())
              .then(data => ({ name: feed.name, icon: feed.icon, items: (data.items || []).map(item => ({...item, feedName: feed.name, feedIcon: feed.icon})) }))
          )).then(results => {
            // 모든 글을 하나의 배열로 합치고, pubDate 기준 최신순 정렬
            const allItems = results.flatMap(feed => feed.items)
              .filter(item => item.pubDate)
              .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
            if (allItems.length > 0) {
              const html = allItems.map(item => `
                <div style=\"margin-bottom:20px;\">
                  <a href=\"${item.link}\" target=\"_blank\" style=\"font-size:1.2em; font-weight:bold;\">${item.title}</a>
                  <span style=\"font-size:0.9em; color:#888; margin-left:8px; vertical-align:middle;\">
                    <img src=\"${item.feedIcon}\" alt=\"icon\" style=\"width:16px; height:16px; vertical-align:middle; margin-right:2px;\">[${item.feedName}]
                  </span>
                  <div style=\"font-size:0.9em; color:#888;\">${item.pubDate ? formatDate(item.pubDate) : ''}</div>
                  ${cleanDescription(item, 'all') ? `<p>${cleanDescription(item, 'all')}</p>` : ''}
                </div>
              `).join('');
              document.getElementById('rss').innerHTML = html;
            } else {
              document.getElementById('rss').innerText = 'RSS 항목이 없습니다.';
            }
          }).catch(err => {
            document.getElementById('rss').innerText = 'RSS를 불러오지 못했습니다.';
            console.error(err);
          });
        } else {
          fetch(feeds[idx].url)
            .then(response => response.json())
            .then(data => {
              if (data.items && data.items.length > 0) {
                const html = data.items.map(item => `
                  <div style=\"margin-bottom:20px;\">
                    <a href=\"${item.link}\" target=\"_blank\" style=\"font-size:1.2em; font-weight:bold;\">${item.title}</a>
                    <span style=\"font-size:0.9em; color:#888; margin-left:8px; vertical-align:middle;\">
                      <img src=\"${feeds[idx].icon}\" alt=\"icon\" style=\"width:16px; height:16px; vertical-align:middle; margin-right:2px;\">[${feeds[idx].name}]
                    </span>
                    <div style=\"font-size:0.9em; color:#888;\">${item.pubDate ? formatDate(item.pubDate) : ''}</div>
                    ${cleanDescription(item, idx) ? `<p>${cleanDescription(item, idx)}</p>` : ''}
                  </div>
                `).join('');
                document.getElementById('rss').innerHTML = html;
              } else {
                document.getElementById('rss').innerText = 'RSS 항목이 없습니다.';
              }
            })
            .catch(err => {
              document.getElementById('rss').innerText = 'RSS를 불러오지 못했습니다.';
              console.error(err);
            });
        }
      }

      function cleanDescription(item, idx) {
        let desc = item.description || '';
        // 우아한테크블로그(woowahan)만 처리
        if ((idx === 'all' && item.feedName === '우아한테크블로그') || (typeof idx === 'number' && feeds[idx].name === '우아한테크블로그')) {
          // 'The post'로 시작하는 부분부터 잘라냄
          const regex = /The post[\s\S]*?first appeared on[\s\S]*?(<[^>]+>|$)/i;
          desc = desc.replace(regex, '');

          // <p>우아한형제들 기술블로그.</p> 또는 <div>우아한형제들 기술블로그.</div> 등 블록 전체 제거
          desc = desc.replace(/<p>\s*우아한형제들 기술블로그\.?(\s|&nbsp;)*<\/p>/gi, '');
          desc = desc.replace(/<div>\s*우아한형제들 기술블로그\.?(\s|&nbsp;)*<\/div>/gi, '');
          // <br> 또는 <br />로만 남은 경우도 제거
          desc = desc.replace(/(우아한형제들 기술블로그\.?\s*)?(<br\s*\/?>)+/gi, '');
          // 남아있는 텍스트에서 우아한형제들 기술블로그.만 남은 경우도 제거
          desc = desc.replace(/우아한형제들 기술블로그\.?/gi, '');

          // 내용이 전부 사라진 경우 빈 문자열로
          if (desc.replace(/(<([^>]+)>)/gi, '').trim() === '') {
            desc = '';
          }
        }
        return desc;
      }

      function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}.${mm}.${dd}`;
      }

      // 첫 번째(전체) 피드 기본 표시
      selectFeed('all');
    </script>
  </body>
</html>
